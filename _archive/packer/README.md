# Building Automated Machine Images with Packer on Proxmox VE

This directory contains Hashicorp Packer configuration files to build an Ubuntu Server 24.04 LTS VM template on Proxmox VE.

This template has been tested with the following specific versions:

- **Proxmox Virtual Environment**: 8.4.0
- **Hashicorp Packer**: v1.12.0
- **Ubuntu Server**: 24.04 LTS (using the official ubuntu-24.04.2-live-server-amd64.iso)

## Prerequisites

1. [Hashicorp Packer](https://www.packer.io/downloads) installed (v1.12.0 or later)
2. Access to a Proxmox VE running version 8.4.0+
3. Ubuntu 24.04.2 ISO installation image already present on the designated Proxmox VE host

Downloading the ISO installation media onto the PVE host can be achieved using the provided shell script (make sure to adjust to your specific environment):

```shell
# Make the download-iso shell script executable
chmod +x download_iso
# Run the shell script
./download_iso
```

## Proxmox VE Configuration

Adjust the `variables.pkrvars.hcl` file to match your environment:

- `proxmox_url`: The URL of the designated Proxmox VE host (API endpoint)
- `proxmox_username`: The Proxmox VE username (it's recommended to create a dedicated entity with a dedicated API token)
- `proxmox_node`: The name of the designated Proxmox VE node
- `vm_id`: The VM ID to use for the template
- `iso_file`: The path to the Ubuntu Server ISO on the designated Proxmox VE node

## The Packer Communicator

On Linux builds Packer uses by default an SSH communicator to establish connectivity to the instantiated VM in order to perform actions (provisioners and post-processors).

Creating an SSH key pair locally can facilitate that easily and securely.
The `cloud-init autoinstall ssh` configuration stanza is used to specify this setting:
(we want to disable password authentication access to enhance security even further)

```yaml
autoinstall:
  # recommended configuration when openssh-server is desired
  ssh:
    install-server: true
    authorized-keys:
      # replace with the contents of the public key(s) as generated by
      # ssh-keygen or similar tools
      - ssh-ed25519 AAAAC3NzaC..6O8tvZobj user@host
    allow-pw: false
```

This configuration ensures that not only can Packer connect during the build, but any VM subsequently created from the resulting template will also have SSH access enabled backed in with the specified public key and password authentication disabled, providing a secure and persistent access method.

## Secrets Handling

Sensitive values such as the Proxmox VE authentication token and a possible SSH password for the Packer communicator will be stored as a security best practice in a separate file and under no circumstance be checked into a version control system.

(the `secrets.pkrvars.hcl` file is included in `.gitignore` to prevent accidental commits of sensitive information).

## Building the Template

Launching the VM template build process can be done by executing the `local-runner` shell script:

```shell
# Make the local-runner shell script executable
chmod +x local-runner
# Run the shell script
./local-runner
```

`local-runner` will use the credentials and the input variables provided in the `secrets.pkrvars.hcl` and the `input.pkrvars.hcl` accordingly.

## The Packer Workflow

1. Packer instantiates a VM on Proxmox VE and attaches a virtual CD-ROM drive from which it boots the specified Ubuntu Server ISO installation media.
2. During boot It attaches a second virtual CD-ROM drive containing the cloud-init user and meta-data files - this is commonly known in cloud-init terminology as a `nocloud` datasource (rather than the HTTP/S endpoint URL query mostly common on cloud platform).
3. Packer performs an automated installation according to the cloud-init directives and configuration provided via the user and meta-data files.
----- steps 1-3 are performed on an ephemral system during the full installation to disk phase -----
4. After installation has completed, and during first boot of the target system Packer will run post-installation shell scripts (through "shell" provisioners) to update the system and install necessary and desired packages.
5. Finally, it converts the VM into a template.

## Cloud-init Configuration Approach

This template creation uses a virtual CD-ROM-based approach for injecting cloud-init configuration data.

- Subiquity is the installer framework handling the Ubuntu Server ISO image ("live server") installation.
- Subiquity's internal `cloud-init` instance will detect the attached cloud-init configuration data files.

This approach offers a few benefits on network-restricted on-premise virtualization platforms like Proxmox VE:

1. Simplicity - as there is no need to fetch the configuration data from a dedicated web server.
2. Reliability - the configuration data is locally attached to the instantiated VM eliminating possible network connectivity issues.
3. Security - no eavesdropping is possible as no data is being transferred over any network.

The relevant files are:

- `cloud-init/user-data`: Contains the cloud-init automated directive (autoinstall) containing the desired configuration
- `cloud-init/meta-data`: Contains cloud-init instance metadata

## Customization

Customizing the template to different needs can be done by adjusting the following files:

- `cloud-init/user-data`: Contains the cloud-init configuration for automated installation
- `cloud-init/meta-data`: Contains the cloud-init instance metadata
- `source-proxmox-iso.pkr.hcl`: Packer source configuration file
- `build-proxmox-iso.pkr.hcl`: Packer build configuration file
- `input.pkrvars.hcl`: Input variables file for customization
- `secrets.pkrvars.hcl`: Sensitive credentials (not committed into version control)

## Using the Template with Terraform

After the template is created, we can utilize it with the Proxmox VE provider for Terraform:

```hcl
resource "proxmox_virtual_environment_vm" "ubuntu_vm" {
  name        = "my-ubuntu-vm"
  description = "Ubuntu VM from template"
  node_name   = "proxmox"
  
  clone {
    vm_id = 9000  # The template VM ID
    full  = true
  }
  
  # Add other configuration as needed
}
```
