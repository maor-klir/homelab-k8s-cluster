apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-cluster-config
  namespace: monitoring
data:
  values.yaml: |
    prometheus:
      prometheusSpec:
        externalLabels:
          cluster: prod
          environment: prod
        remoteWrite:
          - url: http://thanos-receive-router.thanos.svc.cluster.local:19291/api/v1/receive
            writeRelabelConfigs:
              - sourceLabels: [__name__]
                regex: ".*"
                action: keep

    # ============================================
    # GRAFANA - Central Dashboard (Prod Only)
    # ============================================
    grafana:
      enabled: true
      admin:
        existingSecret: grafana-admin-credentials
        userKey: admin-user
        passwordKey: admin-password

      # Ingress configuration
      ingress:
        enabled: true
        ingressClassName: cilium
        annotations:
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        hosts:
          - grafana.cloudandklir.com
        tls:
          - secretName: grafana-tls
            hosts:
              - grafana.cloudandklir.com

      # Grafana configuration
      grafana.ini:
        server:
          root_url: https://grafana.cloudandklir.com
        # Unified Alerting (replaces Alertmanager)
        unified_alerting:
          enabled: true
        alerting:
          enabled: false
        # Feature toggles
        feature_toggles:
          enable: traceToMetrics,correlations
        # Auth
        auth:
          disable_login_form: false
        auth.anonymous:
          enabled: false

      # Datasources - Thanos Query for metrics
      datasources:
        datasources.yaml:
          apiVersion: 1
          datasources:
            - name: Thanos
              type: prometheus
              uid: thanos
              url: http://thanos-query-frontend.thanos.svc.cluster.local:10902
              isDefault: true
              jsonData:
                timeInterval: "30s"

      # Sidecar for dashboard discovery
      sidecar:
        dashboards:
          enabled: true
          label: grafana_dashboard
          labelValue: "1"
          searchNamespace: ALL
        datasources:
          enabled: true
          label: grafana_datasource
          labelValue: "1"

      # Persistence
      persistence:
        enabled: true
        size: 10Gi

      # Disable init-chown-data for local-path-provisioner compatibility
      initChownData:
        enabled: false

      # Resources
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "500m"

      # Default dashboards
      defaultDashboardsEnabled: true
      defaultDashboardsTimezone: utc
